<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WASMå›¾ç‰‡å‹ç¼©å·¥å…·</title>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.10.0/dist/ffmpeg.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            width: 100%;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        header {
            background: linear-gradient(90deg, #4b6cb7 0%, #182848 100%);
            color: white;
            padding: 25px 30px;
            text-align: center;
        }

        header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        header p {
            opacity: 0.9;
            font-size: 16px;
        }

        .content {
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .upload-area {
            border: 2px dashed #4b6cb7;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background-color: #f8faff;
        }

        .upload-area:hover {
            background-color: #eef2ff;
            border-color: #3a5ca9;
        }

        .upload-area.active {
            background-color: #e3ecff;
            border-color: #2c4a8a;
        }

        .upload-icon {
            font-size: 48px;
            color: #4b6cb7;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 18px;
            color: #4b6cb7;
            margin-bottom: 10px;
        }

        .upload-hint {
            font-size: 14px;
            color: #777;
        }

        #file-input {
            display: none;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .quality-control {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .quality-label {
            display: flex;
            justify-content: space-between;
        }

        .quality-label span {
            font-weight: 500;
            color: #333;
        }

        .quality-value {
            font-weight: 600;
            color: #4b6cb7;
        }

        input[type="range"] {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            background: #e0e0e0;
            border-radius: 4px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #4b6cb7;
            border-radius: 50%;
            cursor: pointer;
        }

        .button-group {
            display: flex;
            gap: 15px;
        }

        button {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        #compress-btn {
            background: linear-gradient(90deg, #4b6cb7 0%, #182848 100%);
            color: white;
        }

        #compress-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(75, 108, 183, 0.4);
        }

        #download-btn {
            background: #f0f0f0;
            color: #333;
        }

        #download-btn:hover:not(:disabled) {
            background: #e0e0e0;
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .comparison {
            display: flex;
            gap: 20px;
        }

        .image-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .image-box {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            height: 250px;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #f9f9f9;
        }

        .image-box img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .image-info {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #555;
        }

        .image-label {
            font-weight: 600;
            color: #333;
            text-align: center;
            margin-bottom: 5px;
        }

        .stats {
            display: flex;
            justify-content: space-between;
            background: #f5f7fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #4b6cb7;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(75, 108, 183, 0.2);
            border-left: 4px solid #4b6cb7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .wasm-info {
            background: #eef5ff;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-size: 14px;
            color: #4b6cb7;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .comparison {
                flex-direction: column;
            }

            .button-group {
                flex-direction: column;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>WASMå›¾ç‰‡å‹ç¼©å·¥å…·</h1>
            <p>ä½¿ç”¨WebAssemblyæŠ€æœ¯è¿›è¡Œé«˜æ•ˆçš„å›¾ç‰‡å‹ç¼©</p>
        </header>

        <div class="content">
            <div class="upload-area" id="upload-area">
                <div class="upload-icon">ğŸ“</div>
                <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ”¾å›¾ç‰‡åˆ°æ­¤å¤„</div>
                <div class="upload-hint">æ”¯æŒJPGã€PNGæ ¼å¼ï¼Œæœ€å¤§5MB</div>
                <input type="file" id="file-input" accept="image/jpeg, image/png">
            </div>

            <div class="controls">
                <div class="quality-control">
                    <div class="quality-label">
                        <span>å‹ç¼©è´¨é‡</span>
                        <span class="quality-value" id="quality-value">80%</span>
                    </div>
                    <input type="range" id="quality-slider" min="10" max="100" value="80">
                </div>

                <div class="button-group">
                    <button id="compress-btn" disabled>å‹ç¼©å›¾ç‰‡</button>
                    <button id="download-btn" disabled>ä¸‹è½½å‹ç¼©å›¾</button>
                </div>
            </div>

            <div class="comparison">
                <div class="image-container">
                    <div class="image-label">åŸå›¾</div>
                    <div class="image-box" id="original-image">
                        <span style="color: #999;">å›¾ç‰‡é¢„è§ˆåŒºåŸŸ</span>
                    </div>
                    <div class="image-info">
                        <span>æ ¼å¼: <span id="original-format">-</span></span>
                        <span>å°ºå¯¸: <span id="original-dimensions">-</span></span>
                        <span>å¤§å°: <span id="original-size">-</span></span>
                    </div>
                </div>

                <div class="image-container">
                    <div class="image-label">å‹ç¼©å</div>
                    <div class="image-box" id="compressed-image">
                        <span style="color: #999;">å‹ç¼©åé¢„è§ˆ</span>
                    </div>
                    <div class="image-info">
                        <span>æ ¼å¼: <span id="compressed-format">-</span></span>
                        <span>å°ºå¯¸: <span id="compressed-dimensions">-</span></span>
                        <span>å¤§å°: <span id="compressed-size">-</span></span>
                    </div>
                </div>
            </div>

            <div class="stats">
                <div class="stat-item">
                    <div class="stat-value" id="size-reduction">0%</div>
                    <div class="stat-label">ä½“ç§¯å‡å°‘</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="compression-ratio">1.0x</div>
                    <div class="stat-label">å‹ç¼©æ¯”</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="time-taken">0ms</div>
                    <div class="stat-label">å¤„ç†æ—¶é—´</div>
                </div>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>æ­£åœ¨ä½¿ç”¨WASMå‹ç¼©å›¾ç‰‡ä¸­...</p>
            </div>

            <div class="wasm-info">
                âœ… æ­¤å·¥å…·ä½¿ç”¨WebAssemblyæŠ€æœ¯ï¼Œæä¾›æ¥è¿‘åŸç”Ÿçš„å›¾ç‰‡å‹ç¼©æ€§èƒ½
            </div>
        </div>
    </div>

    <script>
        // é¡µé¢å…ƒç´ 
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');
        const qualitySlider = document.getElementById('quality-slider');
        const qualityValue = document.getElementById('quality-value');
        const compressBtn = document.getElementById('compress-btn');
        const downloadBtn = document.getElementById('download-btn');
        const originalImage = document.getElementById('original-image');
        const compressedImage = document.getElementById('compressed-image');
        const originalFormat = document.getElementById('original-format');
        const originalDimensions = document.getElementById('original-dimensions');
        const originalSize = document.getElementById('original-size');
        const compressedFormat = document.getElementById('compressed-format');
        const compressedDimensions = document.getElementById('compressed-dimensions');
        const compressedSize = document.getElementById('compressed-size');
        const sizeReduction = document.getElementById('size-reduction');
        const compressionRatio = document.getElementById('compression-ratio');
        const timeTaken = document.getElementById('time-taken');
        const loading = document.getElementById('loading');

        // çŠ¶æ€å˜é‡
        let originalFile = null;
        let compressedBlob = null;
        let startTime = 0;

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
        function initEventListeners() {
            // ä¸Šä¼ åŒºåŸŸç‚¹å‡»äº‹ä»¶
            uploadArea.addEventListener('click', () => {
                fileInput.click();
            });

            // æ–‡ä»¶é€‰æ‹©å˜åŒ–äº‹ä»¶
            fileInput.addEventListener('change', handleFileSelect);

            // æ‹–æ”¾äº‹ä»¶
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('active');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('active');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('active');

                if (e.dataTransfer.files.length) {
                    handleFile(e.dataTransfer.files[0]);
                }
            });

            // è´¨é‡æ»‘å—äº‹ä»¶
            qualitySlider.addEventListener('input', () => {
                qualityValue.textContent = `${qualitySlider.value}%`;
            });

            // å‹ç¼©æŒ‰é’®äº‹ä»¶
            compressBtn.addEventListener('click', compressImage);

            // ä¸‹è½½æŒ‰é’®äº‹ä»¶
            downloadBtn.addEventListener('click', downloadImage);
        }

        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFileSelect(e) {
            if (e.target.files.length) {
                handleFile(e.target.files[0]);
            }
        }

        // å¤„ç†æ–‡ä»¶
        function handleFile(file) {
            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            if (!file.type.match('image/jpeg') && !file.type.match('image/png')) {
                alert('è¯·é€‰æ‹©JPGæˆ–PNGæ ¼å¼çš„å›¾ç‰‡ï¼');
                return;
            }

            // æ£€æŸ¥æ–‡ä»¶å¤§å°
            if (file.size > 5 * 1024 * 1024) {
                alert('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡5MBï¼');
                return;
            }

            originalFile = file;

            // æ˜¾ç¤ºåŸå›¾ä¿¡æ¯
            const reader = new FileReader();
            reader.onload = function (e) {
                const img = new Image();
                img.onload = function () {
                    originalImage.innerHTML = '';
                    originalImage.appendChild(img);

                    originalFormat.textContent = file.type.split('/')[1].toUpperCase();
                    originalDimensions.textContent = `${img.width} Ã— ${img.height}`;
                    originalSize.textContent = formatFileSize(file.size);

                    // å¯ç”¨å‹ç¼©æŒ‰é’®
                    compressBtn.disabled = false;

                    // é‡ç½®å‹ç¼©ç»“æœåŒºåŸŸ
                    compressedImage.innerHTML = '<span style="color: #999;">å‹ç¼©åé¢„è§ˆ</span>';
                    compressedFormat.textContent = '-';
                    compressedDimensions.textContent = '-';
                    compressedSize.textContent = '-';
                    sizeReduction.textContent = '0%';
                    compressionRatio.textContent = '1.0x';
                    timeTaken.textContent = '0ms';

                    downloadBtn.disabled = true;
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // å‹ç¼©å›¾ç‰‡
        async function compressImage() {
            if (!originalFile) return;

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            loading.style.display = 'block';
            compressBtn.disabled = true;

            // è®°å½•å¼€å§‹æ—¶é—´
            startTime = performance.now();

            const { createFFmpeg, fetchFile } = FFmpeg;
            const ffmpeg = createFFmpeg({
                log: true, // å¯é€‰ï¼šå¼€å¯æ—¥å¿—
            });

            // åˆå§‹åŒ–
            await ffmpeg.load();
            // ffmpeg.FS('writeFile', 'input.jpg', await fetchFile(originalFile));

            // // è¿è¡ŒFFmpegå‘½ä»¤
            // await ffmpeg.run(
            //     '-i', 'input.jpg',    // è¾“å…¥æ–‡ä»¶
            //     '-qscale', '80',      // è´¨é‡å‚æ•°
            //     'output.jpg'          // è¾“å‡ºæ–‡ä»¶
            // );
            // // ä»è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿè¯»å–ç»“æœ
            // const data = ffmpeg.FS('readFile', 'output.jpg');
            // return new Blob([data.buffer], { type: 'image/jpeg' });



            // const formData = new FormData();
            // formData.append('image', originalFile);
            // const format = 'png'
            // const quality = qualitySlider.value;

            // const response = await fetch(`https://squoosh.app/api/compress?format=${format}&quality=${quality}`, {
            //     method: 'POST',
            //     body: formData
            // });

            // return await response.blob();

            // // æ¨¡æ‹ŸWASMå‹ç¼©è¿‡ç¨‹
            // setTimeout(() => {
            //     return;
            //     // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šè°ƒç”¨WASMæ¨¡å—è¿›è¡Œå‹ç¼©
            //     // è¿™é‡Œä½¿ç”¨Canvas APIæ¨¡æ‹Ÿå‹ç¼©æ•ˆæœ

            //     const img = new Image();
            //     img.onload = function () {
            //         const canvas = document.createElement('canvas');
            //         const ctx = canvas.getContext('2d');

            //         // ä¿æŒåŸå§‹å®½é«˜æ¯”ï¼Œä½†é™åˆ¶æœ€å¤§å°ºå¯¸
            //         const maxDimension = 1200;
            //         let width = img.width;
            //         let height = img.height;

            //         if (width > height && width > maxDimension) {
            //             height = (height * maxDimension) / width;
            //             width = maxDimension;
            //         } else if (height > maxDimension) {
            //             width = (width * maxDimension) / height;
            //             height = maxDimension;
            //         }

            //         canvas.width = width;
            //         canvas.height = height;

            //         // ç»˜åˆ¶å›¾ç‰‡åˆ°Canvas
            //         ctx.drawImage(img, 0, 0, width, height);

            //         // è·å–å‹ç¼©è´¨é‡
            //         const quality = parseInt(qualitySlider.value) / 100;

            //         // è½¬æ¢ä¸ºBlob
            //         canvas.toBlob((blob) => {
            //             // è®¡ç®—å¤„ç†æ—¶é—´
            //             const endTime = performance.now();
            //             const processingTime = Math.round(endTime - startTime);

            //             // æ›´æ–°UI
            //             compressedBlob = blob;

            //             const compressedImg = new Image();
            //             compressedImg.onload = function () {
            //                 compressedImage.innerHTML = '';
            //                 compressedImage.appendChild(compressedImg);

            //                 compressedFormat.textContent = 'JPG';
            //                 compressedDimensions.textContent = `${compressedImg.width} Ã— ${compressedImg.height}`;
            //                 compressedSize.textContent = formatFileSize(blob.size);

            //                 // è®¡ç®—å‹ç¼©ç»Ÿè®¡
            //                 const reduction = ((originalFile.size - blob.size) / originalFile.size * 100).toFixed(1);
            //                 const ratio = (originalFile.size / blob.size).toFixed(1);

            //                 sizeReduction.textContent = `${reduction}%`;
            //                 compressionRatio.textContent = `${ratio}x`;
            //                 timeTaken.textContent = `${processingTime}ms`;

            //                 // å¯ç”¨ä¸‹è½½æŒ‰é’®
            //                 downloadBtn.disabled = false;

            //                 // éšè—åŠ è½½çŠ¶æ€
            //                 loading.style.display = 'none';
            //                 compressBtn.disabled = false;
            //             };
            //             compressedImg.src = URL.createObjectURL(blob);
            //         }, 'image/jpeg', quality);
            //     };
            //     img.src = URL.createObjectURL(originalFile);
            // }, 800); // æ¨¡æ‹ŸWASMåŠ è½½å’Œå¤„ç†æ—¶é—´
        }

        // ä¸‹è½½å›¾ç‰‡
        function downloadImage() {
            if (!compressedBlob) return;

            const a = document.createElement('a');
            a.href = URL.createObjectURL(compressedBlob);
            a.download = `compressed_${originalFile.name.split('.')[0]}.jpg`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes < 1024) {
                return bytes + ' B';
            } else if (bytes < 1024 * 1024) {
                return (bytes / 1024).toFixed(1) + ' KB';
            } else {
                return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
            }
        }

        // åˆå§‹åŒ–
        initEventListeners();
    </script>
</body>

</html>